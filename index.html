<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Amigo Secreto ¬∑ React</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root { --bg:#0b1b2b; --panel:#12263a; --text:#e8f0fe; --muted:#a9c1d9; --accent:#3ebd93; --danger:#ef4444; --primary:#60a5fa; }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0c2238; color:var(--text); }
    .wrap { max-width:960px; margin:0 auto; padding:24px; }
    .card { background:var(--panel); border:1px solid #244869; border-radius:12px; padding:18px; box-shadow: 0 10px 30px rgba(0,0,0,0.35); }
    h1,h2 { margin:0 0 12px 0; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn { border:none; border-radius:10px; padding:12px 16px; font-weight:600; cursor:pointer; color:#06233a; background:var(--accent); box-shadow: 0 8px 16px rgba(62,189,147,0.25); }
    .btn.danger { background:var(--danger); color:#fff; box-shadow: 0 8px 16px rgba(239,68,68,0.25); }
    .table { width:100%; border-collapse:collapse; margin-top:12px; }
    .table th,.table td { border-bottom:1px solid #21445e; padding:8px; text-align:left; font-size:14px; }
    .muted { color:var(--muted); font-size:13px; }
    .error { color:#fecaca; background:#2e1b1b; border:1px solid #7f1d1d; padding:10px 12px; border-radius:10px; margin-top:10px; }
    .success { color:#dcfce7; background:#0f2b1f; border:1px solid #065f46; padding:10px 12px; border-radius:10px; margin-top:10px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://cdn.jsdelivr.net/npm/@babel/standalone/babel.min.js"></script>
  <script type="text/babel">
    const API_URL = 'http://localhost:8089/email/enviar-correo';
    const K = { draw: 'as_draw', sent: 'as_sent' };
    const people = [
      { name:'Fernanda', email:'mayerlijama2@gmail.com' },
      { name:'David', email:'david_velasquez0801@hotmail.com' },
      { name:'Carla', email:'cmcm8c@gmail.com' },
      { name:'Marcia', email:'marcyanee84@hotmail.com' },
      { name:'Betsy', email:'betojca@hotmail.com' },
      { name:'Carlos', email:'carlosaballadarese@gmail.com' },
      { name:'Diego', email:'diego.j.n.pillalaza@hotmail.es' },
      { name:'Adrian', email:'adriano.24c@gmail.com' },
      { name:'Leonardo', email:'lsanchez@manamer.com' },
    ];
    const readJSON = (k,d) => { const v = localStorage.getItem(k); if(!v) return d; try{ return JSON.parse(v);}catch{ return d; } };
    const writeJSON = (k,v) => localStorage.setItem(k, JSON.stringify(v));
    function derangementWithFixed(names, fixedFrom, fixedTo) {
      const N = names.slice();
      if (!N.includes(fixedFrom) || !N.includes(fixedTo)) return null;
      if (fixedFrom === fixedTo) return null;
      const givers = N.filter(n => n !== fixedFrom);
      const recipients = N.filter(n => n !== fixedTo);
      for (let tries = 0; tries < 2000; tries++) {
        const shuffled = recipients.slice();
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        let ok = true;
        for (let i = 0; i < givers.length; i++) { if (givers[i] === shuffled[i]) { ok = false; break; } }
        if (!ok) continue;
        const map = {};
        map[fixedFrom] = fixedTo;
        for (let i = 0; i < givers.length; i++) map[givers[i]] = shuffled[i];
        const seen = new Set(Object.values(map));
        if (seen.size !== N.length) continue;
        return map;
      }
      return null;
    }
    function composeSubject(name) {
      return `‚ú® Con cari√±o, tu Amigo Secreto ‚Äî ${name}`;
    }
    function composeText(name, assigned) {
      return `Hola ${name}!\n\n` +
        `Con mucha alegr√≠a queremos contarte que tu Amigo Secreto es: ${assigned}.\n\n` +
        `Te invitamos a sorprenderle con un detalle especial. Mant√©n la chispa del secreto, ` +
        `comparte sonrisas y deja que la magia de estas fechas los acerque. üéÑüí´\n\n` +
        `Gracias por ser parte. ¬°Que la ilusi√≥n y la calidez te acompa√±en en cada momento!\n` +
        `‚Äî Juego de Amigo Secreto`;
    }
    async function sendEmail(to, subject, text) {
      const body = { destinatarios: [to], asunto: subject, cuerpo: text };
      try {
        const res = await fetch(API_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Accept':'*/*' },
          body: JSON.stringify(body),
          mode:'cors'
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return { verified: true };
      } catch (e) {
        return { verified: false, error: String(e) };
      }
    }
    function App() {
      const [assignments, setAssignments] = React.useState(readJSON(K.draw, null));
      const [sent, setSent] = React.useState(readJSON(K.sent, {}));
      const [msg, setMsg] = React.useState('');
      const [msgType, setMsgType] = React.useState('hidden');
      React.useEffect(() => { writeJSON(K.draw, assignments); }, [assignments]);
      React.useEffect(() => { writeJSON(K.sent, sent); }, [sent]);
      const testCors = async () => {
        setMsg('');
        setMsgType('hidden');
        try {
          const res = await fetch(API_URL, {
            method:'OPTIONS',
            headers:{
              'Access-Control-Request-Method':'POST',
              'Access-Control-Request-Headers':'content-type'
            },
            mode:'cors'
          });
          const allowOrigin = res.headers.get('access-control-allow-origin');
          const allowMethods = res.headers.get('access-control-allow-methods');
          const allowHeaders = res.headers.get('access-control-allow-headers');
          const ok = res.ok;
          setMsg(`Preflight ${res.status} ${ok?'OK':'FAIL'} | Origin: ${allowOrigin||'-'} | Methods: ${allowMethods||'-'} | Headers: ${allowHeaders||'-'}`);
          setMsgType(ok?'success':'error');
        } catch (e) {
          setMsg(`CORS bloqueado: ${String(e)}`);
          setMsgType('error');
        }
      };
      const generate = () => {
        setMsg('');
        setMsgType('hidden');
        if (assignments) { setMsg('Ya existe un sorteo. Usa Reset para regenerar.'); setMsgType('error'); return; }
        const names = people.map(p => p.name);
        const map = derangementWithFixed(names, 'Carlos', 'Betsy');
        if (!map) { setMsg('No fue posible generar el sorteo. Intenta de nuevo.'); setMsgType('error'); return; }
        setAssignments(map);
        setMsg('Sorteo generado y guardado.'); setMsgType('success');
      };
      const resetAll = () => {
        setAssignments(null);
        setSent({});
        localStorage.removeItem(K.draw);
        localStorage.removeItem(K.sent);
        setMsg('Sorteo y estados de env√≠o reiniciados.'); setMsgType('success');
      };
      const sendAll = async () => {
        setMsg('');
        setMsgType('hidden');
        if (!assignments) { setMsg('Primero genera el sorteo.'); setMsgType('error'); return; }
        const updated = { ...sent };
        for (let i = 0; i < people.length; i++) {
          const p = people[i];
          const assigned = assignments[p.name];
          if (!assigned) { updated[p.name] = 'sin asignaci√≥n'; continue; }
          const subject = composeSubject(p.name);
          const text = composeText(p.name, assigned);
          const r = await sendEmail(p.email, subject, text);
          updated[p.name] = r.verified ? 'enviado' : 'enviado*';
        }
        setSent(updated);
        setMsg('Proceso de env√≠o finalizado.'); setMsgType('success');
      };
      const [testEmail, setTestEmail] = React.useState('cmcm8c@gmail.com');
      const [testName, setTestName] = React.useState('Carla');
      const sendTest = async () => {
        setMsg('');
        setMsgType('hidden');
        const assigned = assignments ? (assignments[testName] || '') : '';
        const subject = composeSubject(testName);
        const text = composeText(testName, assigned || 'Betsy');
        const r = await sendEmail(testEmail, subject, text);
        setMsg(r.verified ? 'Prueba enviada y verificada.' : 'Prueba enviada* (pendiente verificaci√≥n por CORS).');
        setMsgType(r.verified ? 'success' : 'error');
      };
      return (
        <div className="wrap">
          <div className="card">
            <h1>Amigo Secreto</h1>
            <div className="muted">Genera el sorteo con la regla Carlos ‚Üí Betsy y env√≠a por correo a cada participante su amigo secreto.</div>
            <div className="row" style={{marginTop:'12px'}}>
              <button className="btn" onClick={generate}>Generar sorteo</button>
              <button className="btn" onClick={sendAll}>Enviar correos</button>
              <button className="btn" onClick={testCors}>Probar CORS</button>
              <button className="btn danger" onClick={resetAll}>Reset</button>
            </div>
            <div className="card" style={{marginTop:'12px'}}>
              <h2>Envio de prueba</h2>
              <div className="row" style={{marginTop:'8px'}}>
                <input value={testEmail} onChange={e=>setTestEmail(e.target.value)} placeholder="correo@ejemplo.com" style={{padding:'10px',borderRadius:'8px',border:'1px solid #244869',background:'#12263a',color:'#e8f0fe',width:'280px'}}/>
                <input value={testName} onChange={e=>setTestName(e.target.value)} placeholder="Nombre" style={{padding:'10px',borderRadius:'8px',border:'1px solid #244869',background:'#12263a',color:'#e8f0fe',width:'160px'}}/>
                <button className="btn" onClick={sendTest}>Enviar prueba</button>
              </div>
              <div className="muted">El estado ‚Äúenviado*‚Äù indica que el navegador no pudo verificar la respuesta por CORS.</div>
            </div>
            <div className={msgType} id="msg">{msg}</div>
            <table className="table">
              <thead>
                <tr>
                  <th>Nombre</th>
                  <th>Correo</th>
                  <th>Asignado</th>
                  <th>Estado env√≠o</th>
                </tr>
              </thead>
              <tbody>
                {people.map(p => (
                  <tr key={p.name}>
                    <td>{p.name}</td>
                    <td>{p.email}</td>
                    <td>{assignments ? (assignments[p.name] || '') : ''}</td>
                    <td>{sent[p.name] || ''}</td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        </div>
      );
    }
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
