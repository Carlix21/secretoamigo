<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Amigo Secreto Â· EnvÃ­o por correo</title>
  <style>
    :root { --bg:#0b1b2b; --panel:#12263a; --text:#e8f0fe; --muted:#a9c1d9; --accent:#3ebd93; --danger:#ef4444; }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#0c2238; color:var(--text); }
    .wrap { max-width:960px; margin:0 auto; padding:24px; }
    .card { background:var(--panel); border:1px solid #244869; border-radius:12px; padding:18px; }
    h1,h2 { margin:0 0 12px 0; }
    .row { display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .btn { border:none; border-radius:10px; padding:12px 16px; font-weight:600; cursor:pointer; color:#06233a; background:var(--accent); }
    .btn.danger { background:var(--danger); color:#fff; }
    .table { width:100%; border-collapse:collapse; margin-top:12px; }
    .table th,.table td { border-bottom:1px solid #21445e; padding:8px; text-align:left; font-size:14px; }
    .muted { color:var(--muted); font-size:13px; }
    .error { color:#fecaca; background:#2e1b1b; border:1px solid #7f1d1d; padding:10px 12px; border-radius:10px; margin-top:10px; }
    .success { color:#dcfce7; background:#0f2b1f; border:1px solid #065f46; padding:10px 12px; border-radius:10px; margin-top:10px; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>Amigo Secreto</h1>
      <div class="muted">Genera el sorteo con la regla Carlos â†’ Betsy y envÃ­a por correo a cada participante su amigo secreto.</div>
      <div class="row" style="margin-top:12px">
        <button id="generateBtn" class="btn">Generar sorteo</button>
        <button id="sendBtn" class="btn">Enviar correos</button>
        <button id="resetBtn" class="btn danger">Reset</button>
      </div>
      <div id="msg" class="hidden"></div>
      <table class="table">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Correo</th>
            <th>Asignado</th>
            <th>Estado envÃ­o</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
  </div>
  <script>
    const SERVER_EMAIL_URL = 'http://192.168.246.110:8088/email/enviar-correo';
    const K = { draw: 'as_draw', sent: 'as_sent' };
    const people = [
      { name:'Fernanda', email:'mayerlijama2@gmail.com' },
      { name:'David', email:'david_velasquez0801@hotmail.com' },
      { name:'Carla', email:'cmcm8c@gmail.com' },
      { name:'Marcia', email:'marcyanee84@hotmail.com' },
      { name:'Betsy', email:'betojca@hotmail.com' },
      { name:'Carlos', email:'carlosaballadarese@gmail.com' },
      { name:'Diego', email:'diego.j.n.pillalaza@hotmail.es' },
      { name:'Adrian', email:'adriano.24c@gmail.com' },
      { name:'Leonardo', email:'lsanchez@manamer.com' },
    ];
    const qs = s => document.querySelector(s);
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');
    const setMsg = (t, type='error') => { const el = qs('#msg'); el.className = type==='success'?'success':'error'; el.textContent = t; show(el); };
    const clearMsg = () => { const el = qs('#msg'); el.textContent=''; el.className='hidden'; };
    const readJSON = (k,d) => { const v = localStorage.getItem(k); if(!v) return d; try{ return JSON.parse(v);}catch{ return d; } };
    const writeJSON = (k,v) => localStorage.setItem(k, JSON.stringify(v));
    function derangementWithFixed(names, fixedFrom, fixedTo) {
      const N = names.slice();
      if (!N.includes(fixedFrom) || !N.includes(fixedTo)) return null;
      if (fixedFrom === fixedTo) return null;
      const givers = N.filter(n => n !== fixedFrom);
      const recipients = N.filter(n => n !== fixedTo);
      for (let tries = 0; tries < 2000; tries++) {
        const shuffled = recipients.slice();
        for (let i = shuffled.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        let ok = true;
        for (let i = 0; i < givers.length; i++) { if (givers[i] === shuffled[i]) { ok = false; break; } }
        if (!ok) continue;
        const map = {};
        map[fixedFrom] = fixedTo;
        for (let i = 0; i < givers.length; i++) map[givers[i]] = shuffled[i];
        const seen = new Set(Object.values(map));
        if (seen.size !== N.length) continue;
        return map;
      }
      return null;
    }
    function getAssignments() { return readJSON(K.draw, null); }
    function setAssignments(m) { writeJSON(K.draw, m); }
    function clearAssignments() { localStorage.removeItem(K.draw); localStorage.removeItem(K.sent); }
    function getSent() { return readJSON(K.sent, {}); }
    function setSent(name, status) { const s = getSent(); s[name] = status; writeJSON(K.sent, s); }
    function renderTable() {
      const tbody = qs('#tbody');
      tbody.innerHTML = '';
      const map = getAssignments() || {};
      const sent = getSent();
      for (let i = 0; i < people.length; i++) {
        const p = people[i];
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${p.name}</td><td>${p.email}</td><td>${map[p.name]||''}</td><td>${sent[p.name]||''}</td>`;
        tbody.appendChild(tr);
      }
    }
    function composeSubject(name, assigned) {
      return `âœ¨ Con cariÃ±o, tu Amigo Secreto â€” ${name}`;
    }
    function composeHtml(name, assigned) {
      return `
      <div style="font-family:Arial, sans-serif; color:#0b1b2b">
        <h2 style="color:#3ebd93;margin:0 0 10px 0">Â¡Hola ${name}!</h2>
        <p style="margin:10px 0">
          Con mucha alegrÃ­a queremos contarte que tu <strong>Amigo Secreto</strong> es:
        </p>
        <div style="background:#12263a;border:1px solid #244869;border-radius:10px;padding:12px;margin:10px 0">
          <h3 style="color:#60a5fa;margin:0;text-align:center">${assigned}</h3>
        </div>
        <p style="margin:10px 0">
          Te invitamos a sorprenderle con un detalle especial. MantÃ©n la chispa del secreto,
          comparte sonrisas y deja que la magia de estas fechas los acerque. ðŸŽ„ðŸ’«
        </p>
        <p style="margin:10px 0">
          Gracias por ser parte. Â¡Que la ilusiÃ³n y la calidez te acompaÃ±en en cada momento!
        </p>
        <hr style="border:none;border-top:1px solid #e2e8f0;margin:16px 0"/>
        <p style="font-size:12px;color:#64748b;margin:0">
          Enviado automÃ¡ticamente para el juego de Amigo Secreto.
        </p>
      </div>
      `;
    }
    async function sendEmail(to, subject, html) {
      const body = { destinatarios: [to], asunto: subject, cuerpo: html };
      try {
        const res = await fetch(SERVER_EMAIL_URL, {
          method:'POST',
          headers:{ 'Content-Type':'application/json', 'Accept':'*/*' },
          body: JSON.stringify(body),
          mode:'cors'
        });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        return { verified: true };
      } catch (e) {
        try {
          await fetch(SERVER_EMAIL_URL, {
            method:'POST',
            headers:{ 'Content-Type':'text/plain' },
            body: JSON.stringify(body),
            mode:'no-cors',
            keepalive:true
          });
          return { verified: false };
        } catch {
          throw e;
        }
      }
    }
    function handleGenerate() {
      clearMsg();
      if (getAssignments()) { setMsg('Ya existe un sorteo. Usa Reset para regenerar.', 'error'); return; }
      const names = people.map(p => p.name);
      const map = derangementWithFixed(names, 'Carlos', 'Betsy');
      if (!map) { setMsg('No fue posible generar el sorteo. Intenta de nuevo.', 'error'); return; }
      setAssignments(map);
      setMsg('Sorteo generado y guardado.', 'success');
      renderTable();
    }
    function handleReset() {
      clearAssignments();
      setMsg('Sorteo y estados de envÃ­o reiniciados.', 'success');
      renderTable();
    }
    async function handleSend() {
      clearMsg();
      const map = getAssignments();
      if (!map) { setMsg('Primero genera el sorteo.', 'error'); return; }
      for (let i = 0; i < people.length; i++) {
        const p = people[i];
        const assigned = map[p.name];
        if (!assigned) { setSent(p.name, 'sin asignaciÃ³n'); continue; }
        const subject = composeSubject(p.name, assigned);
        const html = composeHtml(p.name, assigned);
        try {
          const r = await sendEmail(p.email, subject, html);
          setSent(p.name, r.verified ? 'enviado' : 'enviado*');
        } catch (e) {
          setSent(p.name, 'error');
        }
      }
      setMsg('Proceso de envÃ­o finalizado.', 'success');
      renderTable();
    }
    function boot() {
      qs('#generateBtn').addEventListener('click', handleGenerate);
      qs('#sendBtn').addEventListener('click', handleSend);
      qs('#resetBtn').addEventListener('click', handleReset);
      renderTable();
    }
    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
